# Mothership Verification Pipeline
# This workflow enforces all Mothership checks in CI
# Copy to your project's .github/workflows/ directory

name: Mothership Verify

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

env:
  NODE_VERSION: '20'

jobs:
  # Stage 1: Quick checks (fast, blocks everything)
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for unwired UI handlers
        run: |
          chmod +x ./scripts/check-wiring.sh 2>/dev/null || true
          if [[ -f "./scripts/check-wiring.sh" ]]; then
            ./scripts/check-wiring.sh src/
          else
            # Inline check if script not present
            echo "Checking for empty handlers..."
            if grep -rn "onClick={}\|onSubmit={}\|={() => {})" src/ 2>/dev/null; then
              echo "❌ Empty handlers found"
              exit 1
            fi
            echo "✓ No empty handlers"
          fi

  # Stage 2: Build verification
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: quick-check
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck || npm run type-check || echo "No typecheck script"

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  # Stage 3: Test matrix
  test:
    name: Test Matrix
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.test-type }} tests
        run: |
          case "${{ matrix.test-type }}" in
            unit)
              npm test -- --testPathPattern="unit|\.test\." --passWithNoTests
              ;;
            integration)
              npm test -- --testPathPattern="integration" --passWithNoTests
              ;;
            e2e)
              npm run test:e2e || echo "No e2e tests configured"
              ;;
          esac

  # Stage 4: Security checks
  security:
    name: Security
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Audit dependencies
        run: npm audit --audit-level=high || true

      - name: Check for secrets in code
        run: |
          echo "Checking for hardcoded secrets..."
          if grep -rn "password\s*=\s*['\"][^'\"]*['\"]" src/ --include="*.ts" --include="*.js" 2>/dev/null | grep -v ".test." | grep -v ".spec."; then
            echo "⚠️ Potential hardcoded passwords found"
          fi
          if grep -rn "api_key\s*=\s*['\"]" src/ 2>/dev/null; then
            echo "❌ Hardcoded API keys found"
            exit 1
          fi
          echo "✓ No obvious secrets in code"

  # Stage 5: Docker verification (if Dockerfile exists)
  docker:
    name: Docker
    runs-on: ubuntu-latest
    needs: build
    if: hashFiles('Dockerfile') != ''
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t test-image .

      - name: Test container runs
        run: |
          docker run -d --name test-container -p 3000:3000 test-image
          sleep 30
          if docker ps | grep -q test-container; then
            echo "✓ Container running"
          else
            echo "❌ Container exited"
            docker logs test-container
            exit 1
          fi
          docker stop test-container

  # Stage 6: Accessibility (if configured)
  accessibility:
    name: Accessibility
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true  # Don't block on a11y initially
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: npm run test:a11y || echo "No a11y tests configured"

  # Final gate: All checks must pass
  verify-complete:
    name: Verification Complete
    runs-on: ubuntu-latest
    needs: [quick-check, build, test, security]
    steps:
      - name: All checks passed
        run: |
          echo "╔════════════════════════════════════════════╗"
          echo "║     ALL MOTHERSHIP CHECKS PASSED           ║"
          echo "╚════════════════════════════════════════════╝"
          echo ""
          echo "✓ Quick check (wiring)"
          echo "✓ Build (typecheck, lint, build)"
          echo "✓ Tests (unit, integration, e2e)"
          echo "✓ Security (audit, secrets)"
          echo ""
          echo "Ready to merge."
